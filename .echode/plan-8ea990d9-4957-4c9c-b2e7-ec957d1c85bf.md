# Per-API Key Model Restrictions Feature

## Overview

Add the ability to restrict which models each API key can access. When an API key has allowed models configured, requests using that key will be rejected if they try to use a model not in the allowed list. Empty allowed models = access to all models (current behavior).

## Architecture Flow

```
Request → Extract API Key → Validate Key → Extract Model → Check Model Access → Process Request
                                                ↑
                                          NEW MIDDLEWARE
```

## Backend Changes

### 1. Update APIKey Struct
**File:** `internal/auth/keystore.go`
- Add `AllowedModels []string` field to `APIKey` struct
- Update `Generate()` signature to accept `allowedModels []string`
- Update `Update()` signature to accept `allowedModels []string`

### 2. Update Admin Handlers
**File:** `internal/api/handlers_admin.go`
- Add `AllowedModels []string` to `generateKeyRequest` struct
- Add `AllowedModels []string` to `updateKeyRequest` struct
- Add `AllowedModels []string` to `generateKeyResponse` struct
- Update handlers to pass allowed models to keystore

### 3. Add Model Access Validation Middleware
**File:** `internal/api/middleware.go`
- Create `modelAccessMiddleware()` that:
  - Reads request body (with buffering for re-read)
  - Extracts model from JSON body
  - Gets API key's allowed models
  - Validates model is in allowed list (or list is empty)
  - Returns 403 Forbidden if model not allowed

### 4. Add Admin Models Endpoint
**File:** `internal/api/handlers_admin.go`
- Add `listModelsHandler()` to return available models for admin UI
- Register route in `server.go` under `/admin/models`

### 5. Wire Up Middleware
**File:** `internal/api/server.go`
- Add model access middleware to v1 routes and messages endpoint

## Frontend Changes

### 6. Update Types
**File:** `frontend/src/types/admin.ts`
- Add `allowed_models?: string[]` to `ApiKey` interface
- Add `allowed_models?: string[]` to request interfaces
- Add `ModelInfo` interface for available models

### 7. Update API Client
**File:** `frontend/src/lib/api.ts`
- Add `listModels()` method to fetch available models from `/admin/models`

### 8. Update Admin Hook
**File:** `frontend/src/hooks/use-admin.tsx`
- Add `models` state for available models
- Add `fetchModels()` function
- Fetch models on mount

### 9. Create Model Selector Component
**File:** `frontend/src/components/admin/ModelSelector.tsx`
- Multi-select dropdown for choosing allowed models
- "All Models" option when empty
- Display selected models as badges

### 10. Update CreateKeyForm
**File:** `frontend/src/components/admin/CreateKeyForm.tsx`
- Add ModelSelector component
- Pass allowed_models to createKey

### 11. Update KeyList
**File:** `frontend/src/components/admin/KeyList.tsx`
- Display allowed models column (or "All" if empty)
- Add ModelSelector in edit mode
- Pass allowed_models to updateKey

## File Structure

```
internal/
├── auth/
│   └── keystore.go          # ~15 lines modified
├── api/
│   ├── handlers_admin.go    # ~40 lines modified
│   ├── middleware.go        # ~50 lines added
│   └── server.go            # ~5 lines modified

frontend/src/
├── types/
│   └── admin.ts             # ~15 lines added
├── lib/
│   └── api.ts               # ~10 lines added
├── hooks/
│   └── use-admin.tsx        # ~20 lines added
└── components/admin/
    ├── ModelSelector.tsx    # NEW ~80 lines
    ├── CreateKeyForm.tsx    # ~15 lines modified
    └── KeyList.tsx          # ~30 lines modified
```

## API Changes

### Generate Key Request
```json
{
  "note": "Production App",
  "rate_limit": 60,
  "allowed_models": ["gemini-3-flash", "gemini-3-pro"]  // NEW
}
```

### Key Response
```json
{
  "key": "uuid...",
  "created_at": "2024-...",
  "note": "Production App",
  "rate_limit": 60,
  "allowed_models": ["gemini-3-flash", "gemini-3-pro"]  // NEW
}
```

### New Endpoint: GET /admin/models
```json
{
  "data": [
    {"id": "gemini-3-flash", "display_name": "Gemini 3 Flash"},
    {"id": "gemini-3-pro", "display_name": "Gemini 3 Pro"}
  ]
}
```

## Error Response (403 Forbidden)
```json
{
  "error": {
    "message": "Model 'gemini-3-pro' is not allowed for this API key",
    "type": "permission_error"
  }
}
```

## Edge Cases Handled
- Empty `allowed_models` = unrestricted access (backward compatible)
- Config-based API keys (from YAML) bypass model restrictions
- Invalid model names in allowed list are stored but won't match requests
- Model validation happens after API key validation